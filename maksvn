#!/bin/sh

# maksvn script
# creates folders for out of source build 
# has command line options for realyclean build, for creating diff and for svn update
# has various inline options to EDIT to fit your environnement

# FIXED CHOOSEN BEHAVIOUR :
# 1) Start folder ~/dev/scribus contains both the 'svn' subfolder and the 'build' subfolder
#    'svn' receives svn, 'build' receive build objects
# 2) Result of make go in a subfolder of ~/bin depending on 'rac' variable 

# EDIT to fit your Qt install
qtpath="~/dev/Qt/Qt5.3/5.3"
qtfullpath=$qtpath/gcc_64

# EDIT to fit your langage
mylang="fr;en-us"

# EDIT to fit your cpu cores
cores=8

# EDIT postfix for executable
# when rac is 15svn, executable will be scribus15svn
rac=15svn

# UNCOMMENT and EDIT if you wanna compile an old revision
# todo : specify as an commandline option
# revision=-r18800

if [ "$1" = "-?" ] || [ "$1" = "?" ] || [ "$1" = "-h" ] || [ "$1" = "h" ] || [ "$1" = "help" ] || [ "$1" = "-help" ]
    then 	help="-h"
fi

if test "$help" = "-h";
then
	echo
	echo "Usage : maksvn [-h]ou[-?] [-d]ou[clean] [-nomaj] [diff [dest]]"
	# echo "met à jour le source svn de la 1.5 et compile"
	echo "svn update the source and compile the 1.5"
	echo 
	echo === OPTIONS ====================
	# echo "-h ou -? : affiche cette aide"
	# echo "-d ou clean : efface d'abord les bin et objs déjà là"
	# echo "-nomaj" : pas de mise à jour svn
	# echo "diff : crée le fichier de diff dans dest.diff (ou svnhead.diff sinon)"	
	echo "-h or -? display this help" 
	echo "-d or clean: Deletes previous bin and build files" 
	echo "-noup or -nomaj : dont update to svn head"
	echo "diff or -diff : creates the diff file 'dest.diff' (or 'svnhead.diff' when no dest filename is specified)"
	echo === INFOS ======================
	svn info
	exit
fi

echo ================================

[ ! -d ~/dev ] && mkdir ~/dev
[ ! -d ~/dev/scribus ] && mkdir ~/dev/scribus
[ ! -d ~/bin/scribus$rac ] && mkdir ~/bin/scribus$rac

if [ ! -d ~/dev/scribus ];
then
	echo "Error : could not find nor create ~/dev/scribus"
	exit
fi
cd ~/dev/scribus
[ ! -d ../build ] && mkdir ../build
[ ! -d ../build/$rac ] && mkdir ../build/$rac

if [ ! -d "svn" ]; 
then
	echo "Creating source folder and checkout svn files"
	svn co svn://scribus.net/trunk/Scribus svn
fi

if [ ! -d "svn" ]; 
then
	echo "Error : no svn folder could be created"
	exit
fi

cd svn

if [ "$1" = "diff" ] || [ "$1" = "-diff" ]
then
	if test "$2" = ""  
	then
		dest="svnhead.diff" 
	else dest="${2%.diff}.diff"
	fi
	
	# echo ok on va mettre le diff dans $dest
	echo Lets produce the diff in $dest
	$destroot=$dest
	$dest="../$dest"

	if [ -f  $dest ]; 
	then
		# echo "Effacement de $dest" 
		echo "Deleting $dest" 
		rm $dest
	fi
	svn diff -x -u -x -w -x -b > $dest
	if [ -f $dest ]; 
	then
		cat $dest
		echo "===="
		# echo "Le diff a été mis dans $destroot"
		echo "The diff was produced in $destroot"
		geany $dest
	else
		# echo "! Le diff n'a PAS pu être mis dans $destroot !"
		# echo "$dest n'a pas pu être produit alors voici en direct : "
		echo "! The diff has NOT been put in $destroot !" 
		echo "$dest could not be produced so here live"
		echo "==== !"
		svn diff  -x -u -x -w -x -b
		echo "==== !"
	fi
	exit
fi

if [ "$1" = "-d" ] || [ "$1" = "d" ] || [ "$1" = "-clean" ] || [ "$1" = "clean" ] 
then 
	clean="-d"  
fi

if test "$clean" = "-d"
then
	shift
	echo
	# echo "OK on efface les objets précédents."
	echo "Deleting the foregoing build objects and exec." 
	echo
	sudo rm -rf ~/bin/scribus$rac
	sudo rm -rf ~/dev/scribus/build/$rac
	echo
	echo === Verify
	# echo "=== ~/bin/scribus$rac a été vidé --- il contient :"
	echo "=== ~/bin/scribus$rac was emptied --- it contains :" 
	ls ~/bin/scribus$rac

	echo ---
	# echo "=== ~/dev/scribus/build/build$rac a été vidé --- il contient :"
	echo "=== ~/dev/scribus/build/build$rac was emptied --- it contains :"
	ls ~/dev/scribus/build/$rac
	echo "---"
	echo
	# echo === Fin des vérifs
	echo === End verification
	echo
fi

if [ "$1" = "-noup" ] || [ "$1" = "-nomaj" ]
then
	shift
	echo
	# echo "OK Pas de mise à jour svn"
	echo "NOT updating svn update"
	echo
else
	echo
	# echo "Mise à jour svn" 
	echo "Updating to svn $revision" 
	svn update $revision
	echo
fi

cd ../build/$rac

echo ===
echo
# echo "cmake avec qtfullpath=$qtfullpath"
echo "cmake with qtfullpath=$qtfullpath"

cmake ../../svn -DCMAKE_INSTALL_PREFIX:PATH=~/bin/scribus$rac  -DWANT_GUI_LANG="$mylang" -DWANT_VERSIONING=1 -DQT_PREFIX=$qtfullpath -DWANT_HUNSPELL=1

echo ===
echo
echo make
make -j$cores

echo ===
echo
echo make install
sudo make install

echo ===
echo

sudo ln -s ~/bin/scribus$rac/bin/scribus-1.5.0.svn /usr/bin/scribus$rac
# echo lancer par : scribus$rac
echo Run with scribus$rac
