#!/bin/sh

# maksvn script
# creates folders for out of source build 
# has command line options for realyclean build, for creating diff and for svn update
# has various inline options to EDIT to fit your environnement

# FIXED CHOOSEN BEHAVIOUR :
# 1) Start folder ~/dev/scribus contains both the 'svn' subfolder and the 'build' subfolder
#    'svn' receives svn, 'build' receive build objects
# 2) Result of make go in a subfolder of ~/bin (set $execdirpath variable to change) depending on 'suffix' variable 

# EDIT to fit your Qt install
qtpath="~/dev/Qt/Qt5.3/5.3"
qtfullpath=$qtpath/gcc_64

# en standard execdirpath=~/bin 
# pour que ça soit sur le SSD on met sous /, dans /locabin
execdirpath=/localbin

# EDIT to fit your langage
mylang="fr;en-us"

# EDIT to fit your cpu cores
cores=8

# EDIT suffix = postfix for executable
# when suffix is 15svn, executable will be scribus15svn
suffix=15svn

# UNCOMMENT and EDIT if you wanna compile an old revision
# revision=-r19396
# echo "! BUILD REVISION : $revision !" 

if [ "$1" = "-?" ] || [ "$1" = "?" ] || [ "$1" = "-h" ] || [ "$1" = "h" ] || [ "$1" = "help" ] || [ "$1" = "-help" ]
    then 	help="-h"
fi

if test "$help" = "-h";
then
	echo
	echo "Usage : maksvn [-h]ou[-?] [-d]ou[clean] [-nomaj] [diff [dest]]"
	# echo "met à jour le source svn de la 1.5 et compile"
	echo "svn update the source and compile the 1.5"
	echo 
	echo === OPTIONS ====================
	echo "-h or -? display this help" 
	echo "-d or clean: Deletes previous build files (not the execs)" 
	echo "-noup or -nomaj : dont update to svn head"
	echo "diff or -diff : creates the diff file 'dest.diff' (or 'svnhead.diff' when no dest filename is specified)"
	echo === INFOS ======================
	svn info
	exit
fi

echo ================================

cd ~
pwd

[ ! -d $execdirpath ] && mkdir $execdirpath
[ ! -d $execdirpath ] && echo "Error : exec folder '$execdirpath' does not exist. Create $execdirpath before launching maksvn" && exit
[ ! -d dev ] && mkdir dev
[ ! -d dev/scribus ] && mkdir dev/scribus
[ ! -d bin/scribus$suffix ] && mkdir bin/scribus$suffix

if [ ! -d dev/scribus ];
then
	echo "Error : could not find nor create ~/dev/scribus"
	exit
fi
cd dev/scribus
[ ! -d build ] && mkdir build
[ ! -d build/$suffix ] && mkdir build/$suffix

if [ ! -d "svn" ]; 
then
	echo "Creating source folder and checkout svn files"
	svn co svn://scribus.net/trunk/Scribus svn
fi

if [ ! -d "svn" ]; 
then
	echo "Error : no svn folder could be created"
	exit
fi

cd svn

if [ "$1" = "diff" ] || [ "$1" = "-diff" ]
then
	if test "$2" = ""  
	then
		dest="svnhead.diff" 
	else dest="${2%.diff}.diff"
	fi
	
	# echo ok on va mettre le diff dans $dest
	echo Lets produce the diff in $dest
	destroot="$dest"
	dest="../$dest"

	if [ -f  $dest ]; 
	then
		# echo "Effacement de $dest" 
		echo "Deleting $dest" 
		rm $dest
	fi
	svn diff -x -u -x -w -x -b > $dest
	if [ -f $dest ]; 
	then
		cat $dest
		echo "===="
		# echo "Le diff a été mis dans $destroot"
		echo "The diff was produced in $destroot"
		geany $dest
	else
		# echo "! Le diff n'a PAS pu être mis dans $destroot !"
		# echo "$dest n'a pas pu être produit alors voici en direct : "
		echo "! The diff has NOT been put in $destroot !" 
		echo "$dest could not be produced so here live"
		echo "==== !"
		svn diff  -x -u -x -w -x -b
		echo "==== !"
	fi
	exit
fi

if [ "$1" = "-d" ] || [ "$1" = "d" ] || [ "$1" = "-clean" ] || [ "$1" = "clean" ] 
then 
	clean="-d"  
fi

if test "$clean" = "-d"
then
	shift
	echo
	echo "Deleting the foregoing build objects." 
	echo
#	sudo rm -rf $execdirpath/scribus$suffix/*
	sudo rm -rf ~/dev/scribus/build/$suffix/*
	echo "~/dev/scribus/build/build$suffix was emptied --- it contains :"
	ls ~/dev/scribus/build/$suffix
	echo
fi

if [ "$1" = "-noup" ] || [ "$1" = "-nomaj" ]
then
	shift
	echo
	echo "NOT updating svn update"
	echo
else
	echo
	echo "Updating to svn $revision" 
	svn update $revision
	echo
fi

pwd
cd ../build/$suffix

echo ===
echo
echo "cmake with qtfullpath=$qtfullpath"

cmake ../../svn -DCMAKE_INSTALL_PREFIX:PATH=$execdirpath/scribus$suffix  -DWANT_GUI_LANG="$mylang" -DWANT_VERSIONING=1 -DQT_PREFIX=$qtfullpath -DWANT_HUNSPELL=1 -DWANT_GRAPHICSMAGICK=1 -DWANT_SVNVERSION=1

echo ===
echo
echo make
make -j$cores

echo ===
echo
echo make install to $execdirpath
sudo make install

echo ===
echo

sudo unlink /usr/bin/scribus$suffix
sudo ln -s $execdirpath/scribus$suffix/bin/scribus-1.5.0.svn /usr/bin/scribus$suffix
echo exec is $execdirpath/scribus$suffix/bin/scribus-1.5.0.svn
echo Run with scribus$suffix
